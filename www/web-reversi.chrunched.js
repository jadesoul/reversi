String.prototype.format=function(){var s=this.valueOf();for(var i=0;i<arguments.length;i++){var re=new RegExp('\\\{'+i+'\\\};','g');s=s.replace(re,arguments[i]);};return s;};var $a={$b:0,$c:1,$d:2,$e:3,$f:4};var $g={$h:0,$i:1,$j:2,$k:3,$l:4,$m:5,UP:6,$n:7};var $o={$a:$a,$g:$g};var $p=function($q,$r,$s,$t){this.state=$s;this.row=$q;this.col=$r;this.div=$t;this.setState=function(s){this.setEmpty();this.state=s;if(s==$a.BLACK){this.div.addClass('chess-black');}else if(s==$a.WHITE){this.div.addClass('chess-white');}else if(s==$a.B_SEL){this.div.addClass('chess-black-select');}else if(s==$a.W_SEL){this.div.addClass('chess-white-select');}};this.setEmpty=function(){this.state=$a.EMPTY;this.div.removeClass('chess-black').removeClass('chess-white').removeClass('chess-black-select').removeClass('chess-white-select');};this.nextGrid=function(d){var i=this.row,j=this.col;if(d==$g.RIGHT){if(j==8)return null;else return $u.map.grid(i,j+1);}else if(d==$g.RIGHT_DOWN){if(i==8||j==8)return null;else return $u.map.grid(i+1,j+1);}else if(d==$g.DOWN){if(i==8)return null;else return $u.map.grid(i+1,j);}else if(d==$g.LEFT_DOWN){if(i==8||j==1)return null;else return $u.map.grid(i+1,j-1);}else if(d==$g.LEFT){if(j==1)return null;else return $u.map.grid(i,j-1);}else if(d==$g.LEFT_UP){if(i==1||j==1)return null;else return $u.map.grid(i-1,j-1);}else if(d==$g.UP){if(i==1)return null;else return $u.map.grid(i-1,j);}else if(d==$g.RIGHT_UP){if(i==1||j==8)return null;else return $u.map.grid(i-1,j+1);}}};var $v=function(m){this.rows=new Array();for(var i=0;i<=8;i++){var $w=new Array();for(var j=0;j<=8;j++){if(i==0||j==0)$w.push('^_^');else $w.push(new $p(i,j,$a.EMPTY,$('#board div.chess[id=chess_'+i+'_'+j+']')));};this.rows.push($w);};this.grid=function(r,c){return this.rows[r][c];};this.init=function(m){m||(m='0000000000000000000000000001200000021000000000000000000000000000');for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){var n=m[(i-1)*8+j-1];this.grid(i,j).setState(parseInt('0'+n));}}};this.toString=function(){var s='';for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){s+=this.rows[i][j].state;}};return s;};this.init(m);};var $x=function(name,$y){this.name='default name';this.color=$y;this.oppo=(this.color==$a.BLACK?$a.WHITE:$a.BLACK);this.guys=[];this.avails=[];this.findAvails=function(){this.avails=[];for(var i=0;i<this.guys.length;i++){for(var d=0;d<8;d++){var g=this.guys[i];g=g.nextGrid(d);if(!g||g.state!=this.oppo)continue;for(;g&&g.state==this.oppo;g=g.nextGrid(d));if(g&&g.state==$a.EMPTY&&$.inArray(g,this.avails)==-1){g.setState(this.color+2);this.avails.push(g);}}};return this.avails.length;};this.refreshGuys=function(){var $z=$u.map;this.guys=[];for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){if($z.grid(i,j).state==this.color)this.guys.push($z.grid(i,j));}};return this.guys.length;};this.eatFrom=function(r,c){var g=$u.map.grid(r,c);if(g.state!=this.color+2)return;if($.inArray(g,this.avails)==-1)return;g.setState(this.color);var $A=g;var $B=0;for(var d=0;d<8;++d){var $C=[];g=$A;g=g.nextGrid(d);if(!g||g.state!=this.oppo)continue;for(;g&&g.state==this.oppo;g=g.nextGrid(d))$C.push(g);if(g&&g.state==this.color){$B+=$C.length;for(var i=0;i<$C.length;i++){$C[i].setState(this.color);}}};return $B;};this.putChess=function(r,c){this.eatFrom(r,c);};this.nextDirection=function(d){if(d==$g.RIGHT_UP)return $g.RIGHT;return d+1;};this.toString=function(){return this.name+' (执'+(this.color==$a.BLACK?'黑':'白')+'子,上次棋子数'+this.guys.length+',上次可下位置数'+this.avails.length+')'};return this;};$x.ComputerPlayer=function(name,$y){this.name=name;this.color=$y;this.oppo=(this.color==$a.BLACK?$a.WHITE:$a.BLACK);this.AI={$D:'http://localhost/cgi-bin/reversi-ai-web-engine',$E:1.0};this.play=function(){if($u.over)return $u.gameOver('游戏已结束，重新再来一局吧！');$u.clearSel();$.get(this.AI.url+'?'+$u.map.toString()+$u.turn,this.realPlay);};this.realPlay=function(r){$u.clearSel();$u.np.refreshGuys();if($u.np.findAvails()>0){if(!(r&&r.length==2&&r[0]>=1&&r[0]<=8&&r[1]>=1&&r[1]<=8))alert('engine error, result:'+r);var g=$u.map.grid(r[0],r[1]);if(g.state!=$u.np.color+2)alert('engine error:select');if($.inArray(g,$u.np.avails)==-1)alert('engine error:avails');$u.np.putChess(r[0],r[1]);}else{return alert('fatal error');};$u.showChessCount();if($u.b+$u.w==64)return $u.gameOver('游戏已结束，棋盘被下满了！');$u.changePlayer();$u.clearSel();if($u.np.refreshGuys()==0)return $u.gameOver('真悲惨，'+$u.np+'的棋子被吃光了!');if($u.np.findAvails()==0){if($u.onePassed&&$u.onePassed!=$u.np){return $u.gameOver('双方都无子可下，游戏结束!');}else{$u.onePassed=$u.np;alert($u.np+' 得弃权啦，没有地方下子!');$u.changePlayer();$u.np.refreshGuys();if($u.np.findAvails()==0){return $u.gameOver('双方都无子可下，游戏结束!');}}};$u.onePassed=null;setTimeout('game.np.play()',10);};return this;};$x.HumanPlayer=function(name,$y){this.name=name;this.color=$y;this.oppo=(this.color==$a.BLACK?$a.WHITE:$a.BLACK);this.play=function(){if($u.over)return $u.gameOver('游戏已结束，重新再来一局吧！');};this.realPlay=function(r,c){if($u.over)return $u.gameOver('游戏已结束，重新再来一局吧！');$u.clearSel();$u.np.refreshGuys();if($u.np.findAvails()>0){if(!(r&&c&&r>=1&&r<=8&&c>=1&&c<=8))alert('do not try to cheat ^_^ : r='+r);var g=$u.map.grid(r,c);if(g.state!=$u.np.color+2)return;if($.inArray(g,$u.np.avails)==-1)return;$u.np.putChess(r,c);}else{return alert('fatal error');};$u.showChessCount();if($u.b+$u.w==64)return $u.gameOver('游戏已结束，棋盘被下满了！');$u.changePlayer();$u.clearSel();if($u.np.refreshGuys()==0)return $u.gameOver('真悲惨，'+$u.np+'的棋子被吃光了!');if($u.np.findAvails()==0){if($u.onePassed&&$u.onePassed!=$u.np){return $u.gameOver('双方都无子可下，游戏结束!');}else{$u.onePassed=$u.np;alert($u.np+' 得弃权啦，没有地方下子!');$u.changePlayer();$u.clearSel();$u.np.refreshGuys();if($u.np.findAvails()==0){return $u.gameOver('双方都无子可下，游戏结束!');}}};$u.onePassed=null;setTimeout('game.np.play()',100);};return this;};$x.ComputerPlayer.prototype=new $x();$x.HumanPlayer.prototype=new $x();function Game(){this.author='jadesoul';this.version=1.0;};Game.Reversi=function($F,$G,$H){this.turn=$a.BLACK;this.bp=$F;this.wp=$G;this.np=$F;this.onePassed=null;this.over=false;this.b=0;this.w=0;this.e=0;this.map=new $v($H);this.start=function(){$u.clearSel();$u.showChessCount();$u.np.refreshGuys();$u.np.findAvails();setTimeout('game.np.play()',300);};this.reset=function(){this.clearSel();this.map.init();};this.clearSel=function(){for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){var s=$u.map.grid(i,j).state;if(s==$a.B_SEL||s==$a.W_SEL){$u.map.grid(i,j).setEmpty();}}}};this.changePlayer=function(){if(this.np==this.bp){this.np=this.wp;this.turn=$a.WHITE;}else{this.np=this.bp;this.turn=$a.BLACK;}};this.gameOver=function($I){this.over=true;this.clearSel();var b=0,w=0,e=0;for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){if(this.map.grid(i,j).state==$a.EMPTY)e++;else if(this.map.grid(i,j).state==$a.BLACK)b++;else if(this.map.grid(i,j).state==$a.WHITE)w++;}};alert('=========== game over =============\n\n'+$I+'\n'+$u.bp.name+'执黑先下以 '+b+':'+w+' '+(b>w?'战胜':(b<w?'败给':'打平'))+$u.wp.name+'剩余空格数: '+e);};this.showChessCount=function(){$u.clearSel();this.b=this.w=this.e=0;for(var i=1;i<=8;i++){for(var j=1;j<=8;j++){if(this.map.grid(i,j).state==$a.EMPTY)this.e++;else if(this.map.grid(i,j).state==$a.BLACK)this.b++;else if(this.map.grid(i,j).state==$a.WHITE)this.w++;}};$('#chess-black-count').html('<center style="margin-top:10px;">深蓝<br/>'+this.b+'</center>');$('#chess-white-count').html('<center style="margin-top:10px;">游客<br/>'+this.w+'</center>');if(this.b+this.w==64||this.b==0||this.w==0)$u.over=true;};return this;};Game.Reversi.prototype=new Game();function initGUI(){var i=r=c=0;$('#board td').each(function(){r=parseInt(i/8)+1;c=i%8+1;i++;$(this).empty().append('<div id="chess_'+r+'_'+c+'" class="chess chess-white"></div>');})$('#board div.chess').click(function(){var $J=this.id.split('_');$u.np.realPlay($J[1],$J[2]);})};var $u;$(function(){initGUI();$u=new Game.Reversi(new $x.ComputerPlayer('深蓝',$a.BLACK),new $x.HumanPlayer('游客',$a.WHITE));$u.start();})


